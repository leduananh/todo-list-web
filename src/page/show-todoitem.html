<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todoitem</title>
    <script type="module">
        import { loadHtmlUtil } from '../util/loadHtml.js'
        import { header } from '../component/header.js'
        // Dùng để load bootstrap file tự động không cần copy paste 
        loadHtmlUtil.loadDefaultBootstrapsCss()

        document.addEventListener('DOMContentLoaded', () => {
            // dùng để load những đoạn html bị lặp lại nhiều trang như header, footer
            loadHtmlUtil.render(header.selector, header.html, { name: 'hello' })
        })
    </script>
</head>

<body>
    <header id="header-section">
    </header>
    <span>Danh sách các công việc của: <b id="show-todoname"></b> trong <b id="show-subname"></b></span>
    <ul id="danh-muc-todoitem"></ul>

    <script type="module">
        import { subCategoryService } from '../service/subCategoryService.js'
        import { categoryService } from '../service/categoryService.js'
        import { commonUtil } from '../util/common.js'
        import { todoItemService } from '../service/todoItemService.js'
        import { checkBox } from '../util/CheckBox.js'

        window.categoryService = categoryService
        window.subCategoryService = subCategoryService
        window.commonUtil = commonUtil

        let data = commonUtil.loadQueryParamValueByQueryName('data')
        const objectTodo = JSON.parse(decodeURIComponent(data))

        const ListTodoItem = todoItemService.getAllTodoItemByTodoName(objectTodo.name)

        document.addEventListener('DOMContentLoaded', function (e) {
            // Hàm sửa nội dung được đưa vào phạm vi toàn cục
            window.SuaNoiDung = function(button) {
                const targetId = button.getAttribute('data-idnd');
                const element = document.getElementById(targetId);
                const newContent = prompt(`Nhập nội dung mới cho ${targetId}:`);
                if (newContent !== null && newContent.trim() !== '') {
                    element.textContent = newContent;
                }
                const LoadTodoItem = JSON.parse(localStorage.getItem('TODO_ITEM'))
                const  objitem =LoadTodoItem.find(item => item.id === targetId)
                objitem.title = newContent
                let index = LoadTodoItem.findIndex(item => item.id === objitem.id)
                LoadTodoItem[index]= objitem
                localStorage.setItem('TODO_ITEM',JSON.stringify(LoadTodoItem))
            }
             // Hàm sửa ngay được đưa vào phạm vi toàn cục
             window.SuaNgay = function(button) {
                const targetId = button.getAttribute('data-idnd');
                const element = document.getElementById(targetId);
                const newContent = prompt(`Nhập ngày hết hạn mới (dd/mm/yyyy):`);
                if (newContent !== null && newContent.trim() !== '') {
                    element.textContent = newContent;
                }
                const LoadTodoItem = JSON.parse(localStorage.getItem('TODO_ITEM'))
                const  objitem =LoadTodoItem.find(item => item.id === targetId.slice(0, -2))
                objitem.dueDate = newContent
                let index = LoadTodoItem.findIndex(item => item.id === objitem.id)
                LoadTodoItem[index]= objitem
                localStorage.setItem('TODO_ITEM',JSON.stringify(LoadTodoItem))
            }
            //  Hàm xoá
            window.Xoa = function(button){
                const targetId = button.getAttribute('data-idxoa')
                const LoadTodoItem = JSON.parse(localStorage.getItem('TODO_ITEM'))
                const  objitem =LoadTodoItem.filter(item => item.id !== targetId)
                localStorage.setItem('TODO_ITEM',JSON.stringify(objitem))
                location.reload()
            }
            let ct = ''
            // Vòng lặp for of
            if (ListTodoItem.length > 0) {
                for (let Todo of ListTodoItem) {
                    const categoryItemHtmlStringTemplate = `
                        <li style="font-size: 20px "> Nội dung: <b id="${Todo.id}" style="color: blue">${Todo.title}</b> </li>
                        <button data-idnd="${Todo.id}" onclick="SuaNoiDung(this)">Sửa nội dung</button>
                        <p>
                        <div> ID: ${Todo.id} </div>
                        <div> Check box đã hoàn thành: <input type="checkbox" id="${Todo.id}" class="check"> </div>
                        <div> Ngày bắt đầu: ${Todo.createdDate} </div>
                        <div> Ngày hết hạn: <b id="${Todo.id}DD">${Todo.dueDate}</b> <button data-idnd="${Todo.id}DD" onclick="SuaNgay(this)">Sửa</button></div>
                        <button data-idxoa="${Todo.id}"  onclick="Xoa(this)" style= " color: red "> Xoá toàn bộ nội dung</button>
                        </p>

                    `
                    ct = ct + categoryItemHtmlStringTemplate
                }
                if (ListTodoItem.length === 0) {
                    ct = '<h1>No subcategory</h1>'
                }
            }
            const ulTag = document.querySelector('#danh-muc-todoitem');
            ulTag.innerHTML = ct

            var checkboxes = document.querySelectorAll('.check');
            checkboxes.forEach(function (checkbox) {
                checkbox.addEventListener('change', function () {
                    if (this.checked) {
                        alert(this.nextSibling.textContent.trim() + 'Đã hoàn thành');
                        checkBox.saveData()
                    } else {
                        alert(this.nextSibling.textContent.trim() + 'Chưa hoàn thành');
                        checkBox.saveData()
                    }
                });
            });

            window.onload = function () {
                checkBox.loadData()
            }
        })

        document.querySelector('#show-todoname').innerText = objectTodo.name
        document.querySelector('#show-subname').innerText = objectTodo.subCategoryName

    </script>
</body>

</html>
